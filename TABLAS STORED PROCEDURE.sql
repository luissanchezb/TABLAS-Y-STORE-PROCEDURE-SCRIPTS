
----CREACION DE TABLAS-----

CREATE TABLE CUENTA (
   IDCUENTA             int                  not null,
   SALDO                numeric(10,2)        null,
   constraint PK_CUENTA primary key (IDCUENTA)
);

ALTER TABLE CUENTA ADD CHECK (SALDO>=0);

CREATE TABLE MOVIMIENTO (
   IDMOVIMIENTO         int  GENERATED BY DEFAULT AS IDENTITY(START WITH 1 INCREMENT BY 1)   not null,
   IDCUENTA             int                  null,
   TIPOMOVIMIENTO       varchar(2)           null,
   VALOR                numeric(10,2)        null,
   constraint PK_MOVIMIENTO primary key (IDMOVIMIENTO)
);

CREATE TABLE TRANSFERENCIA (
   IDCUENTAORIGEN       int                  null,
   IDCUENTADESTINO      int                  null,
   IMPORTE              numeric(10,2)        null
);

ALTER TABLE MOVIMIENTO
   add constraint FK_MOVIMIEN_FK3_CUENTA foreign key (IDCUENTA)
      references CUENTA (IDCUENTA);


ALTER TABLE TRANSFERENCIA
   add constraint FK_cuentadestino_CUENTA foreign key (IDCUENTADESTINO)
      references CUENTA (IDCUENTA);

ALTER TABLE TRANSFERENCIA
   add constraint FK_cuentaorigen_CUENTA foreign key (IDCUENTAORIGEN)
      references CUENTA (IDCUENTA);



--INSERT PARA LA TABLA CUENTA--

INSERT INTO CUENTA VALUES(1,200),(2,0);





----STORED PROCEDURE TRANSACCIONAL---

CREATE PROCEDURE PA_INSERTAR_TRANSACCIONAL
(PIDCUENTAORIGEN INT, PIDCUENTADESTINO INT,  PVALOR NUMERIC(10,2))
AS $$
BEGIN
BEGIN 
   INSERT INTO TRANSFERENCIA VALUES (PIDCUENTAORIGEN,PIDCUENTADESTINO,PVALOR);
   INSERT INTO MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) VALUES (PIDCUENTADESTINO,'A',PVALOR);
   UPDATE CUENTA SET SALDO=saldo+PVALOR WHERE IDCUENTA=PIDCUENTADESTINO;
   INSERT INTO MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) VALUES (PIDCUENTAORIGEN,'D',PVALOR);
   UPDATE CUENTA SET SALDO=saldo-PVALOR WHERE IDCUENTA=PIDCUENTAORIGEN;
END;
EXCEPTION
WHEN OTHERS THEN 
ROLLBACK;
RAISE EXCEPTION 'No se pudo ejecutar la transacci√≥n';
END;  $$ LANGUAGE plpgsql;





----STORED PROCEDURE NO TRANSACCIONAL---


CREATE PROCEDURE PA_INSERTAR_NO_TRANSACCIONAL
(PIDCUENTAORIGEN INT, PIDCUENTADESTINO INT,  PVALOR NUMERIC(10,2))
AS $$
BEGIN
 INSERT INTO TRANSFERENCIA VALUES (PIDCUENTAORIGEN,PIDCUENTADESTINO,PVALOR);
 INSERT INTO MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) VALUES (PIDCUENTADESTINO,'A',PVALOR);
 UPDATE CUENTA SET SALDO=saldo+PVALOR WHERE IDCUENTA=PIDCUENTADESTINO;
 INSERT INTO MOVIMIENTO(IDCUENTA,TIPOMOVIMIENTO,VALOR) VALUES (PIDCUENTAORIGEN,'D',PVALOR);
 UPDATE CUENTA SET SALDO=saldo-PVALOR WHERE IDCUENTA=PIDCUENTAORIGEN;
END;
$$ LANGUAGE plpgsql;
